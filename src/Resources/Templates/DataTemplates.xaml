<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
                    xmlns:domain="clr-namespace:AnalysisNorm.Models.Domain"
                    xmlns:services="clr-namespace:AnalysisNorm.Services.Interfaces">

    <!-- Performance Metrics Data Template -->
    <DataTemplate x:Key="PerformanceMetricsTemplate" DataType="{x:Type services:PerformanceMetrics}">
        <materialDesign:Card Margin="4" Padding="12" materialDesign:ShadowAssist.ShadowDepth="Depth1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Memory Usage -->
                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Memory" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Память:" VerticalAlignment="Center"/>
                </StackPanel>
                <TextBlock Grid.Row="0" Grid.Column="1" 
                         Text="{Binding MemoryUsageMB, StringFormat='{}{0:F1} MB'}"
                         FontWeight="SemiBold" VerticalAlignment="Center"/>

                <!-- Active Operations -->
                <StackPanel Grid.Row="1" Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Cogs" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Операции:" VerticalAlignment="Center"/>
                </StackPanel>
                <TextBlock Grid.Row="1" Grid.Column="1" 
                         Text="{Binding ActiveOperations}"
                         FontWeight="SemiBold" VerticalAlignment="Center"/>

                <!-- Last Operation Time -->
                <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Timer" Width="16" Height="16" 
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="Последняя:" VerticalAlignment="Center"/>
                </StackPanel>
                <TextBlock Grid.Row="2" Grid.Column="1" 
                         Text="{Binding LastOperationTime, StringFormat='{}{0:F0} мс'}"
                         FontWeight="SemiBold" VerticalAlignment="Center"/>
            </Grid>
        </materialDesign:Card>
    </DataTemplate>

    <!-- Operation Metric Data Template -->
    <DataTemplate x:Key="OperationMetricTemplate" DataType="{x:Type services:OperationMetric}">
        <Border BorderBrush="{DynamicResource MaterialDesignDivider}" 
                BorderThickness="0,0,0,1" Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding Name}" 
                         VerticalAlignment="Center" FontWeight="Medium"/>
                
                <TextBlock Grid.Column="1" 
                         Text="{Binding Duration, StringFormat='{}{0:mm\\:ss\\.fff}'}"
                         VerticalAlignment="Center" Margin="8,0"
                         FontFamily="Consolas" FontSize="11"/>
                
                <materialDesign:PackIcon Grid.Column="2" Width="12" Height="12"
                                       VerticalAlignment="Center">
                    <materialDesign:PackIcon.Style>
                        <Style TargetType="materialDesign:PackIcon">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Duration.TotalSeconds, Converter={StaticResource GreaterThanConverter}, ConverterParameter=5}" Value="True">
                                    <Setter Property="Kind" Value="AlertCircle"/>
                                    <Setter Property="Foreground" Value="#FF9800"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Duration.TotalSeconds, Converter={StaticResource LessThanConverter}, ConverterParameter=1}" Value="True">
                                    <Setter Property="Kind" Value="CheckCircle"/>
                                    <Setter Property="Foreground" Value="#4CAF50"/>
                                </DataTrigger>
                            </Style.Triggers>
                            <Setter Property="Kind" Value="Information"/>
                            <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBodyLight}"/>
                        </Style>
                    </materialDesign:PackIcon.Style>
                </materialDesign:PackIcon>
            </Grid>
        </Border>
    </DataTemplate>

    <!-- Norm Data Template -->
    <DataTemplate x:Key="NormTemplate" DataType="{x:Type domain:Norm}">
        <materialDesign:Card Margin="4" Padding="12">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Norm Header -->
                <StackPanel Grid.Row="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="ChartLine" Width="16" Height="16"
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding Id, StringFormat='Норма №{0}'}" 
                             FontWeight="SemiBold" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Type}" Margin="8,0,0,0"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"
                             VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Points Count -->
                <TextBlock Grid.Row="1" Margin="0,4,0,0"
                         Text="{Binding Points.Count, StringFormat='Точек данных: {0}'}"
                         FontSize="12" 
                         Foreground="{DynamicResource MaterialDesignBodyLight}"/>

                <!-- Load Range -->
                <TextBlock Grid.Row="2" Margin="0,2,0,0"
                         FontSize="12"
                         Foreground="{DynamicResource MaterialDesignBodyLight}">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="Диапазон: {0:F1} - {1:F1}">
                            <Binding Path="LoadRange.Min"/>
                            <Binding Path="LoadRange.Max"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>
            </Grid>
        </materialDesign:Card>
    </DataTemplate>

    <!-- Route Data Template -->
    <DataTemplate x:Key="RouteTemplate" DataType="{x:Type domain:Route}">
        <materialDesign:Card Margin="4" Padding="12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Route Header -->
                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal">
                    <materialDesign:PackIcon Kind="Train" Width="16" Height="16"
                                           VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding Number, StringFormat='Маршрут №{0}'}" 
                             FontWeight="SemiBold" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Status Indicator -->
                <materialDesign:PackIcon Grid.Row="0" Grid.Column="1" Width="16" Height="16"
                                       VerticalAlignment="Center">
                    <materialDesign:PackIcon.Style>
                        <Style TargetType="materialDesign:PackIcon">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding TotalDeviationPercent, Converter={StaticResource AbsoluteValueConverter}, Converter={StaticResource LessThanConverter}, ConverterParameter=5}" Value="True">
                                    <Setter Property="Kind" Value="CheckCircle"/>
                                    <Setter Property="Foreground" Value="#4CAF50"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding TotalDeviationPercent, Converter={StaticResource AbsoluteValueConverter}, Converter={StaticResource GreaterThanConverter}, ConverterParameter=20}" Value="True">
                                    <Setter Property="Kind" Value="AlertCircle"/>
                                    <Setter Property="Foreground" Value="#F44336"/>
                                </DataTrigger>
                            </Style.Triggers>
                            <Setter Property="Kind" Value="Information"/>
                            <Setter Property="Foreground" Value="#FF9800"/>
                        </Style>
                    </materialDesign:PackIcon.Style>
                </materialDesign:PackIcon>

                <!-- Route Details -->
                <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0"
                         Text="{Binding Date, StringFormat='dd.MM.yyyy'}"
                         FontSize="12" 
                         Foreground="{DynamicResource MaterialDesignBodyLight}"/>

                <!-- Consumption Summary -->
                <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,4,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" FontSize="11"
                             Text="{Binding TotalActualConsumption, StringFormat='Факт: {0:F1}'}"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                    
                    <TextBlock Grid.Column="1" FontSize="11"
                             Text="{Binding TotalNormConsumption, StringFormat='Норма: {0:F1}'}"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                    
                    <TextBlock Grid.Column="2" FontSize="11" FontWeight="Medium"
                             Text="{Binding TotalDeviationPercent, StringFormat='{0:+0.0;-0.0;0.0}%'}">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding TotalDeviationPercent, Converter={StaticResource LessThanConverter}, ConverterParameter=0}" Value="True">
                                        <Setter Property="Foreground" Value="#4CAF50"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding TotalDeviationPercent, Converter={StaticResource GreaterThanConverter}, ConverterParameter=5}" Value="True">
                                        <Setter Property="Foreground" Value="#F44336"/>
                                    </DataTrigger>
                                </Style.Triggers>
                                <Setter Property="Foreground" Value="{DynamicResource MaterialDesignBody}"/>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Grid>
        </materialDesign:Card>
    </DataTemplate>

    <!-- Processing Error Template -->
    <DataTemplate x:Key="ProcessingErrorTemplate" DataType="{x:Type domain:ProcessingError}">
        <Border BorderBrush="{DynamicResource MaterialDesignDivider}" 
                BorderThickness="0,0,0,1" Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <materialDesign:PackIcon Grid.Column="0" Width="16" Height="16"
                                       VerticalAlignment="Top" Margin="0,0,8,0">
                    <materialDesign:PackIcon.Style>
                        <Style TargetType="materialDesign:PackIcon">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Severity}" Value="Information">
                                    <Setter Property="Kind" Value="Information"/>
                                    <Setter Property="Foreground" Value="#2196F3"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Severity}" Value="Warning">
                                    <Setter Property="Kind" Value="Alert"/>
                                    <Setter Property="Foreground" Value="#FF9800"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Severity}" Value="Error">
                                    <Setter Property="Kind" Value="CloseCircle"/>
                                    <Setter Property="Foreground" Value="#F44336"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Severity}" Value="Critical">
                                    <Setter Property="Kind" Value="AlertOctagon"/>
                                    <Setter Property="Foreground" Value="#D32F2F"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </materialDesign:PackIcon.Style>
                </materialDesign:PackIcon>

                <StackPanel Grid.Column="1">
                    <TextBlock Text="{Binding Message}" TextWrapping="Wrap" 
                             FontWeight="Medium"/>
                    <TextBlock Text="{Binding Context}" TextWrapping="Wrap" 
                             FontSize="11" Margin="0,2,0,0"
                             Foreground="{DynamicResource MaterialDesignBodyLight}"
                             Visibility="{Binding Context, Converter={StaticResource NullToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>
    </DataTemplate>

</ResourceDictionary>